<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vida no Prato - Colaborador</title>
    <link rel="stylesheet" href="/css/painel-admin.css">
</head>

<body>
    <div id="authModal" class="auth-modal">
        <div class="auth-modal-content">
            <div class="auth-header">
                <span class="auth-close" onclick="closeAuthModal()">&times;</span>
                
                <h2 id="authTitle">üå± Acesso ao Painel de Colaboradores</h2>
                <p>Bem-vindo! Fa√ßa login ou cadastre seu estabelecimento.</p>
            </div>
            
            <div class="auth-body">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login" onclick="switchAdminTab('login')">Entrar</button>
                    <button class="auth-tab" data-tab="register" onclick="switchAdminTab('register')">Cadastrar</button>
                </div>

                <form class="auth-form active" id="loginForm">
                    <div class="form-group">
                        <label for="loginCnpj">CNPJ (estabelecimento)</label>
                        <input type="text" id="loginCnpj" placeholder="00.000.000/0000-00" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword">Senha</label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="off">
                        <span class="password-toggle" onclick="togglePassword('loginPassword')">üëÅÔ∏è</span>
                    </div>
                    
                    <button type="submit" class="auth-submit">Entrar na Conta</button>
                </form>

                <form class="auth-form" id="adminRegisterForm">
                    <div class="form-group">
                        <label for="adminRegisterName">Nome do Respons√°vel</label>
                        <input type="text" id="adminRegisterName" placeholder="Seu nome completo" required>
                        <span class="input-icon">üë§</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminRegisterEmail">E-mail</label>
                        <input type="email" id="adminRegisterEmail" placeholder="seu@email.com" required>
                        <span class="input-icon">üìß</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminRegisterPhone">Telefone</label>
                        <input type="tel" id="adminRegisterPhone" placeholder="(11) 99999-9999">
                        <span class="input-icon">üì±</span>
                    </div>

                    <div class="form-group">
                        <label for="adminRegisterCnpj">CNPJ do Estabelecimento</label>
                        <input type="text" id="adminRegisterCnpj" placeholder="00.000.000/0000-00" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminRegisterPassword">Senha</label>
                        <input type="password" id="adminRegisterPassword" placeholder="M√≠nimo 6 caracteres" required autocomplete="off">
                        <span class="password-toggle" onclick="togglePassword('adminRegisterPassword')">üëÅÔ∏è</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="adminConfirmPassword">Confirmar Senha</label>
                        <input type="password" id="adminConfirmPassword" placeholder="Confirme sua senha" required autocomplete="off">
                        <span class="password-toggle" onclick="togglePassword('adminConfirmPassword')">üëÅÔ∏è</span>
                    </div>
                    
                    <button type="submit" class="auth-submit">Criar Conta</button>
                </form>
            </div>
        </div>
    </div>

    <div id="adminPanelWrapper" style="display:none;">
        <header class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="flex: 1; text-align: center;">
                    <h1 style="margin-top:0; margin-bottom: 4px;">üå± Vida no Prato - Painel dos Colaboradores</h1>
                    <p style="margin: 0; font-size: 0.95em;">Gerencie seus produtos e categorias</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="viewProfile()" style="padding: 10px 16px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">üë§ Meu Perfil</button>
                    <button onclick="logout()" style="padding: 10px 16px; background: #d32f2f; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">üö™ Sair</button>
                </div>
            </div>
            <div id="welcomeAnimation"
                style="display:none;position:fixed;bottom:30px;right:30px;z-index:2000;min-width:340px;padding:22px 32px;background:linear-gradient(135deg,#4caf50,#2e7d32);color:#fff;border-radius:16px;box-shadow:0 8px 32px rgba(46,125,50,0.18);font-size:1.25rem;">
                <span style="font-size:1.7rem;vertical-align:middle;margin-right:10px;">üå±</span>
                Bem-vindo ao Painel dos Colaboradores!
            </div>
        </header>

        <div class="container">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalProducts">0</div>
                    <div>Produtos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalCategories">0</div>
                    <div>Categorias</div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('products', this)">üì¶ Produtos</button>
                <button class="tab" onclick="showTab('categories', this)">üè∑Ô∏è Categorias</button>
            </div>

            <div class="tab-content active" id="products">
                <h2 id="productFormTitle">Adicionar Produto</h2>
                <form id="productForm" class="form-grid" enctype="multipart/form-data">
                    <input type="hidden" id="productIdEdit">
                    <input type="hidden" id="productImageExisting">
                    <div class="form-group"><label>Nome *</label><input type="text" id="productName" required></div>
                    <div class="form-group"><label>Pre√ßo (R$) *</label><input type="number" step="0.01"
                            id="productPrice" required></div>
                    <div class="form-group"><label>Categoria *</label><select id="productCategory" required></select>
                    </div>
                    <div class="form-group"><label>√çcone (Emoji)</label><input type="text" id="productEmoji">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Imagem do Produto (PNG, JPG, GIF)</label>
                        <input type="file" id="productImage" name="imagem" accept="image/png, image/jpeg, image/gif">
                        <div id="imagePreview" style="margin-top: 15px; font-size: 0.9em; color: #555;"></div>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;"><label>Descri√ß√£o *</label><textarea
                            id="productDescription" rows="3" required></textarea></div>
                    <div style="grid-column: 1 / -1;">
                        <button type="submit" class="btn" id="productSubmitBtn">‚úÖ Adicionar Produto</button>
                        <button type="button" class="btn" id="productCancelBtn"
                            style="display:none;background:#ccc;color:#333;margin-left:10px;">Cancelar</button>
                    </div>
                </form>
                <table class="data-table" id="productsTable">
                    <thead>
                        <tr>
                            <th>√çcone</th>
                            <th>Nome</th>
                            <th>Categoria</th>
                            <th>Pre√ßo</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="tab-content" id="categories">
                <h2 id="categoryFormTitle">Adicionar Categoria</h2>
                <form id="categoryForm" class="form-grid">
                    <input type="hidden" id="categoryIdEdit">
                    <div class="form-group"><label>Nome *</label><input type="text" id="categoryName" required></div>
                    <div class="form-group"><label>Chave *</label><input type="text" id="categoryKey" required></div>
                    <div class="form-group">
                        <label>√çcone</label>
                        <input type="hidden" id="categoryEmoji">
                        <div class="emoji-grid">
                            <button type="button" class="emoji-btn" data-emoji="ü•ó">ü•ó</button>
                            <button type="button" class="emoji-btn" data-emoji="üç≤">üç≤</button>
                            <button type="button" class="emoji-btn" data-emoji="üåØ">üåØ</button>
                            <button type="button" class="emoji-btn" data-emoji="ü•™">ü•™</button>
                            <button type="button" class="emoji-btn" data-emoji="üçï">üçï</button>
                            <button type="button" class="emoji-btn" data-emoji="üçù">üçù</button>
                            <button type="button" class="emoji-btn" data-emoji="üçú">üçú</button>
                            <button type="button" class="emoji-btn" data-emoji="üç£">üç£</button>
                            <button type="button" class="emoji-btn" data-emoji="ü•§">ü•§</button>
                            <button type="button" class="emoji-btn" data-emoji="‚òï">‚òï</button>
                            <button type="button" class="emoji-btn" data-emoji="üç∞">üç∞</button>
                            <button type="button" class="emoji-btn" data-emoji="üçâ">üçâ</button>
                            <button type="button" class="emoji-btn" data-emoji="ü•ë">ü•ë</button>
                            <button type="button" class="emoji-btn" data-emoji="ü•ï">ü•ï</button>
                            <button type="button" class="emoji-btn" data-emoji="ü•¶">ü•¶</button>
                        </div>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;"><label>Descri√ß√£o *</label><textarea
                            id="categoryDescription" rows="3" required></textarea></div>
                    <div style="grid-column: 1 / -1;">
                        <button type="submit" class="btn" id="categorySubmitBtn">‚úÖ Adicionar Categoria</button>
                        <button type="button" class="btn" id="categoryCancelBtn"
                            style="display:none;background:#ccc;color:#333;margin-left:10px;">Cancelar</button>
                    </div>
                </form>
                <table class="data-table" id="categoriesTable">
                    <thead>
                        <tr>
                            <th>√çcone</th>
                            <th>Nome</th>
                            <th>Chave</th>
                            <th>Produtos</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- FUN√á√ïES GLOBAIS ---
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const toggle = input.nextElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                toggle.textContent = 'üôà';
            } else {
                input.type = 'password';
                toggle.textContent = 'üëÅÔ∏è';
            }
        }

        function toggleCNPJMask(inputId) {
            const input = document.getElementById(inputId);
            const toggle = input.nextElementSibling;
            
            // Se for um input de texto normal, muda para password (esconde com pontos)
            if (input.type === 'text') {
                input.type = 'password';
                toggle.textContent = 'üëÅÔ∏è';
            } else {
                input.type = 'text';
                toggle.textContent = 'üôà';
            }
        }

        function formatCNPJ(value) {
            // Remove tudo que n√£o √© n√∫mero
            const cleaned = value.replace(/\D/g, '');
            
            // Limita a 14 d√≠gitos
            const limited = cleaned.slice(0, 14);
            
            // Aplica a m√°scara: XX.XXX.XXX/XXXX-XX
            let formatted = '';
            if (limited.length > 0) formatted = limited.slice(0, 2);
            if (limited.length > 2) formatted += '.' + limited.slice(2, 5);
            if (limited.length > 5) formatted += '.' + limited.slice(5, 8);
            if (limited.length > 8) formatted += '/' + limited.slice(8, 12);
            if (limited.length > 12) formatted += '-' + limited.slice(12, 14);
            
            return formatted;
        }

        function setupCNPJMask(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            input.addEventListener('input', function() {
                this.value = formatCNPJ(this.value);
            });
        }

        function maskPhone(phone) {
            phone = phone.replace(/\D/g, '');
            if (phone.length > 11) phone = phone.slice(0, 11);
            
            if (phone.length <= 2) return phone;
            if (phone.length <= 7) return phone.replace(/(\d{2})(\d+)/, '($1) $2');
            return phone.replace(/(\d{2})(\d{5})(\d+)/, '($1) $2-$3');
        }

        function setupPhoneMask(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            input.addEventListener('input', function() {
                this.value = maskPhone(this.value);
            });
        }

        // Fun√ß√£o antiga foi removida. Agora o bot√£o X usa window.location.href no HTML
        function closeAuthModal() {
            // Mantida vazia ou redirecionando caso algum outro lugar chame
            window.location.href = '/'; 
        }

        function switchAdminTab(tabName) {
            // Remove ativa de todas as abas
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Marca a aba correta como ativa
            const activeTab = document.querySelector(`.auth-tab[data-tab="${tabName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // Remove ativo de todos os formul√°rios
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
            
            // Mostra o formul√°rio correto
            const formId = tabName === 'login' ? 'loginForm' : 'adminRegisterForm';
            const activeForm = document.getElementById(formId);
            if (activeForm) {
                activeForm.classList.add('active');
            }
        }

        // Vari√°vel global para armazenar dados do usu√°rio logado
        let usuarioLogado = null;

        function viewProfile() {
            if (usuarioLogado && usuarioLogado.id) {
                window.location.href = `/colaborador/perfil/${usuarioLogado.id}`;
            } else {
                alert('Erro: dados do usu√°rio n√£o encontrados.');
            }
        }

        function logout() {
            if (confirm('Deseja realmente sair?')) {
                usuarioLogado = null;
                document.getElementById('adminPanelWrapper').style.display = 'none';
                document.getElementById('authModal').style.display = 'block';
                document.getElementById('loginForm').reset();
                document.getElementById('adminRegisterForm').reset();
                switchAdminTab('login');
            }
        }

        // --- FUN√á√ïES DO PAINEL ADMIN ---
        function showWelcomeAnimation() {
            const anim = document.getElementById('welcomeAnimation');
            anim.style.display = 'block';
            setTimeout(() => { anim.style.display = 'none'; }, 2200);
        }

        function showTab(tabName, btn) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            if (btn) {
                btn.classList.add('active');
            } else {
                // Fallback: procura pela aba pelo conte√∫do
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => {
                    if (tab.textContent.trim().toLowerCase().includes(tabName.toLowerCase())) {
                        tab.classList.add('active');
                    }
                });
            }
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }

        function setupEmojiPickers() {
            document.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.onclick = function () {
                    const input = this.closest('.form-group').querySelector('input[type="hidden"]');
                    input.value = this.dataset.emoji;
                    this.closest('.emoji-grid').querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                };
            });
        }

        async function populateCategories() {
            const res = await fetch('/categorias');
            const categorias = await res.json();
            const select = document.getElementById('productCategory');
            select.innerHTML = '<option value="">Selecione</option>';
            categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = `${cat.emoji || ''} ${cat.nome}`;
                select.appendChild(option);
            });
            document.getElementById('totalCategories').textContent = categorias.length;
        }

        async function displayProducts() {
            const res = await fetch('/produtos');
            const produtos = await res.json();
            const tbody = document.querySelector('#productsTable tbody');
            tbody.innerHTML = '';
            produtos.forEach(produto => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${produto.emoji || ''}</td>
                    <td>${produto.nome}</td>
                    <td>${produto.categoria}</td>
                    <td>R$ ${(Number(produto.preco) || 0).toFixed(2).replace('.', ',')}</td>
                    <td>
                        <button class="btn btn-sm" onclick="editProduct(${produto.id})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct(${produto.id})">üóëÔ∏è</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('totalProducts').textContent = produtos.length;
        }

        async function displayCategories() {
            const res = await fetch('/categorias');
            const categorias = await res.json();
            const tbody = document.querySelector('#categoriesTable tbody');
            tbody.innerHTML = '';
            categorias.forEach(cat => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cat.emoji || ''}</td>
                    <td>${cat.nome}</td>
                    <td>${cat.slug}</td>
                    <td>${cat.total_produtos || 0}</td>
                    <td>
                        <button class="btn btn-sm" onclick="editCategory(${cat.id})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCategory(${cat.id})">üóëÔ∏è</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        window.editProduct = async function (id) {
            const res = await fetch(`/produtos`);
            const produto = (await res.json()).find(p => p.id === id);
            if (!produto) return;
            document.getElementById('productIdEdit').value = produto.id;
            document.getElementById('productName').value = produto.nome;
            document.getElementById('productPrice').value = produto.preco;
            document.getElementById('productCategory').value = produto.categoria_id;
            document.getElementById('productEmoji').value = produto.emoji;
            document.getElementById('productDescription').value = produto.descricao;
            const imagePreview = document.getElementById('imagePreview');
            if (produto.imagem) {
                document.getElementById('productImageExisting').value = produto.imagem;
                imagePreview.innerHTML = `<p>Imagem atual:</p><img src="/images/uploads/${produto.imagem}" width="100" style="border-radius: 8px;"/>`;
            } else {
                imagePreview.innerHTML = '<p>Nenhuma imagem cadastrada.</p>';
            }
            document.getElementById('productFormTitle').textContent = 'Editar Produto';
            document.getElementById('productSubmitBtn').textContent = 'üíæ Salvar Altera√ß√µes';
            document.getElementById('productCancelBtn').style.display = 'inline-block';
        };

        window.deleteProduct = async function (id) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                const res = await fetch(`/produtos/${id}`, { method: 'DELETE' });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const message = err.message || 'Erro ao excluir produto.';
                    // If blocked by FK constraint, offer forced deletion
                    if (res.status === 400 && message.includes('pedido')) {
                        if (confirm(message + '\n\nDeseja for√ßar a exclus√£o (remover√° os itens de pedidos relacionados)?')) {
                            const res2 = await fetch(`/produtos/${id}?force=true`, { method: 'DELETE' });
                            if (!res2.ok) {
                                const err2 = await res2.json().catch(() => ({}));
                                alert(err2.message || 'Erro ao for√ßar exclus√£o do produto.');
                            } else {
                                displayProducts();
                            }
                        }
                    } else {
                        alert(message);
                    }
                } else {
                    displayProducts();
                }
            }
        };

        window.editCategory = async function (id) {
            const res = await fetch(`/categorias`);
            const cat = (await res.json()).find(c => c.id === id);
            if (!cat) return;
            document.getElementById('categoryIdEdit').value = cat.id;
            document.getElementById('categoryName').value = cat.nome;
            document.getElementById('categoryKey').value = cat.slug;
            document.getElementById('categoryEmoji').value = cat.emoji;
            document.getElementById('categoryDescription').value = cat.descricao;
            document.getElementById('categoryFormTitle').textContent = 'Editar Categoria';
            document.getElementById('categorySubmitBtn').textContent = 'üíæ Salvar Altera√ß√µes';
            document.getElementById('categoryCancelBtn').style.display = 'inline-block';
        };

        window.deleteCategory = async function (id) {
            if (confirm('Tem certeza que deseja excluir esta categoria?')) {
                const res = await fetch(`/categorias/${id}`, { method: 'DELETE' });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const message = err.message || 'Erro ao excluir categoria.';
                    // If blocked because category has products, offer forced deletion
                    if (res.status === 400 && message.includes('produtos')) {
                        if (confirm(message + '\n\nDeseja for√ßar a exclus√£o (remover√° todos os produtos e itens relacionados)?')) {
                            const res2 = await fetch(`/categorias/${id}?force=true`, { method: 'DELETE' });
                            if (!res2.ok) {
                                const err2 = await res2.json().catch(() => ({}));
                                alert(err2.message || 'Erro ao for√ßar exclus√£o da categoria.');
                            } else {
                                populateCategories();
                                displayCategories();
                            }
                        }
                    } else {
                        alert(message);
                    }
                } else {
                    populateCategories();
                    displayCategories();
                }
            }
        };

        document.addEventListener('DOMContentLoaded', function () {
            // Inicializar m√°scaras de CNPJ
            setupCNPJMask('loginCnpj');
            setupCNPJMask('adminRegisterCnpj');
            setupPhoneMask('adminRegisterPhone');
            
            document.getElementById('loginForm').addEventListener('submit', async function (event) {
                event.preventDefault();
                const cnpjRaw = document.getElementById('loginCnpj').value;
                const cnpj = cnpjRaw.replace(/\D/g, '');
                const password = document.getElementById('loginPassword').value;

                try {
                    const res = await fetch('/auth/login-collaborator', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ cnpj, senha: password })
                    });
                    const data = await res.json();
                    if (data.success) {
                        usuarioLogado = data.usuario;
                        document.getElementById('authModal').style.display = 'none';
                        document.getElementById('adminPanelWrapper').style.display = 'block';
                        showWelcomeAnimation();
                        populateCategories();
                        displayProducts();
                        displayCategories();
                        setupEmojiPickers();
                    } else {
                        alert(data.message || 'CNPJ ou senha inv√°lidos!');
                    }
                } catch (err) {
                    console.error('Erro ao fazer login:', err);
                    alert('Erro ao fazer login. Veja o console para detalhes.');
                }
            });

            // Handler para o formul√°rio de registro do painel (CNPJ obrigat√≥rio para estabelecimento)
            const adminRegisterForm = document.getElementById('adminRegisterForm');
            if (adminRegisterForm) {
                adminRegisterForm.addEventListener('submit', async (ev) => {
                    ev.preventDefault();
                    const nome = document.getElementById('adminRegisterName').value;
                    const email = document.getElementById('adminRegisterEmail').value;
                    const telefone = document.getElementById('adminRegisterPhone').value;
                    const cnpjRaw = document.getElementById('adminRegisterCnpj').value || '';
                    const cnpj = cnpjRaw.replace(/\D/g, '');
                    const senha = document.getElementById('adminRegisterPassword').value;
                    const confirmSenha = document.getElementById('adminConfirmPassword').value;

                    if (senha !== confirmSenha) {
                        alert('As senhas n√£o coincidem!');
                        return;
                    }

                    try {
                        const res = await fetch('/auth/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ nome, email, telefone, senha, cnpj })
                        });
                        const data = await res.json();
                        if (data.success) {
                            alert('Cadastro realizado com sucesso! Use as credenciais para entrar.');
                            // Preenche o formul√°rio de login com os dados rec√©m-criados
                            document.getElementById('loginCnpj').value = cnpj;
                            document.getElementById('loginPassword').value = senha;
                            switchAdminTab('login');
                        } else {
                            alert(data.message || 'Erro ao cadastrar.');
                            console.error('Erro no registro:', data);
                        }
                    } catch (err) {
                        console.error('Erro ao cadastrar:', err);
                        alert('Erro ao cadastrar. Verifique o console do navegador (F12) para mais detalhes.');
                    }
                });
            }

            document.getElementById('productForm').onsubmit = async function (e) {
                e.preventDefault();
                const id = document.getElementById('productIdEdit').value;
                const formData = new FormData();
                formData.append('nome', document.getElementById('productName').value);
                formData.append('preco', document.getElementById('productPrice').value);
                formData.append('categoria_id', document.getElementById('productCategory').value);
                formData.append('emoji', document.getElementById('productEmoji').value);
                formData.append('descricao', document.getElementById('productDescription').value);
                const imageFile = document.getElementById('productImage').files[0];
                if (imageFile) {
                    formData.append('imagem', imageFile);
                } else if (id) {
                    formData.append('imagem_existente', document.getElementById('productImageExisting').value);
                }
                const url = id ? `/produtos/${id}` : '/produtos';
                const method = id ? 'PUT' : 'POST';
                await fetch(url, {
                    method: method,
                    body: formData
                });
                document.getElementById('productCancelBtn').click();
                displayProducts();
            };

            document.getElementById('categoryForm').onsubmit = async function (e) {
                e.preventDefault();
                const id = document.getElementById('categoryIdEdit').value;
                const payload = {
                    nome: document.getElementById('categoryName').value,
                    chave: document.getElementById('categoryKey').value,
                    emoji: document.getElementById('categoryEmoji').value,
                    descricao: document.getElementById('categoryDescription').value
                };
                await fetch(id ? `/categorias/${id}` : '/categorias', {
                    method: id ? 'PUT' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                document.getElementById('categoryCancelBtn').click();
                populateCategories();
                displayCategories();
            };

            document.getElementById('productCancelBtn').onclick = function () {
                this.form.reset();
                document.getElementById('productIdEdit').value = '';
                document.getElementById('imagePreview').innerHTML = '';
                document.getElementById('productImageExisting').value = '';
                document.getElementById('productFormTitle').textContent = 'Adicionar Produto';
                document.getElementById('productSubmitBtn').textContent = '‚úÖ Adicionar Produto';
                this.style.display = 'none';
            };

            document.getElementById('categoryCancelBtn').onclick = function () {
                this.form.reset();
                document.getElementById('categoryIdEdit').value = '';
                document.getElementById('categoryFormTitle').textContent = 'Adicionar Categoria';
                document.getElementById('categorySubmitBtn').textContent = '‚úÖ Adicionar Categoria';
                this.style.display = 'none';
            };
        });
    </script>
</body>

</html>